@page "/breeding"
@rendermode InteractiveServer
@using System.Linq
@using TripleDerby.SharedKernel
@using TripleDerby.SharedKernel.Pagination
@using TripleDerby.Web.ApiClients.Abstractions
@using TripleDerby.Web.Components.Ui;

@inject IBreedingApiClient BreedingApi
@inject IUserApiClient UserApi

<PageTitle>Breeding</PageTitle>

<h1>Breeding</h1>

<FluentGrid>
    <FluentGridItem xs="12" sm="12" md="6">
        @if (_loadingDams)
        {
            <div>Loading dams...</div>
        }
        else if (!_dams.Any())
        {
            <div>No dams available.</div>
        }
        else
        {
            <h2>Dams</h2>
            <HorizontalCardSelector TItem="HorseResult"
                                    Items="@_dams.ToList()"
                                    SelectedIndex="@SelectedDamIndex"
                                    SelectedIndexChanged="i => SelectedDamIndex = i"
                                    SelectedItemChanged="OnDamChanged">
                <ItemTemplate Context="horse">
                    <FlipCard MinimalStyle="true" Height="250px" Width="300px">
                        <Front>
                            <div class="card-top">
                                <div class="card-image">
                                    <FluentEmoji Value="@(new Emojis.AnimalsNature.Color.Default.Horse())" />
                                </div>
                            </div>
                            <div class="card-bottom">
                                <div class="card-name">@horse.Name</div>
                                <div class="card-earnings">$@horse.Earnings</div>
                            </div>
                        </Front>
                        <Back>
                            <div class="card-stats">
                                <div class="card-title">Stats</div>
                                <div class="stat-row"><div class="stat-label">Starts</div><div class="stat-value">@horse.RaceStarts</div></div>
                                <div class="stat-row"><div class="stat-label">Wins</div><div class="stat-value">@horse.RaceWins</div></div>
                                <div class="stat-row"><div class="stat-label">Place</div><div class="stat-value">@horse.RacePlace</div></div>
                                <div class="stat-row"><div class="stat-label">Show</div><div class="stat-value">@horse.RaceShow</div></div>
                                <div class="stat-row"><div class="stat-label">Sire</div><div class="stat-value">@(horse.Sire ?? "-")</div></div>
                                <div class="stat-row"><div class="stat-label">Dam</div><div class="stat-value">@(horse.Dam ?? "-")</div></div>
                            </div>
                        </Back>
                    </FlipCard>
                </ItemTemplate>
            </HorizontalCardSelector>
        }
    </FluentGridItem>
    <FluentGridItem xs="12" sm="12" md="6">
    @if (_loadingSires)
    {
        <div>Loading sires...</div>
    }
    else if (!_sires.Any())
    {
        <div>No sires available.</div>
    }
    else
    {
        <h2>Sires</h2>
        <HorizontalCardSelector TItem="HorseResult"
                                Items="@_sires.ToList()"
                                SelectedIndex="@SelectedSireIndex"
                                SelectedIndexChanged="i => SelectedSireIndex = i"
                                SelectedItemChanged="OnSireChanged">
            <ItemTemplate Context="horse">
                <FlipCard MinimalStyle="true" Height="250px" Width="300px">
                    <Front>
                        <div class="card-top">
                            <div class="card-image">
                                <FluentEmoji Value="@(new Emojis.AnimalsNature.Color.Default.Horse())"/>
                            </div>
                        </div>
                        <div class="card-bottom">
                            <div class="card-name">@horse.Name</div>
                            <div class="card-earnings">$@horse.Earnings</div>
                        </div>
                    </Front>
                    <Back>
                        <div class="card-stats">
                            <div class="card-title">Stats</div>
                            <div class="stat-row">
                                <div class="stat-label">Starts</div>
                                <div class="stat-value">@horse.RaceStarts</div></div>
                            <div class="stat-row">
                                <div class="stat-label">Wins</div>
                                <div class="stat-value">@horse.RaceWins</div></div>
                            <div class="stat-row">
                                <div class="stat-label">Place</div>
                                <div class="stat-value">@horse.RacePlace</div></div>
                            <div class="stat-row">
                                <div class="stat-label">Show</div>
                                <div class="stat-value">@horse.RaceShow</div></div>
                            <div class="stat-row">
                                <div class="stat-label">Sire</div>
                                <div class="stat-value">@(horse.Sire ?? "-")</div></div>
                            <div class="stat-row">
                                <div class="stat-label">Dam</div>
                                <div class="stat-value">@(horse.Dam ?? "-")</div></div>
                        </div>
                    </Back>
                </FlipCard>
            </ItemTemplate>
        </HorizontalCardSelector>
    }
    </FluentGridItem>
</FluentGrid>

<div style="margin-top:1rem;">
    <label ><strong>Owner</strong></label>

    <FluentAutocomplete TOption="UserResult"
                        Width="320px"
                        Placeholder="Search users by username"
                        OptionText="@(u => $"{u.Username} ({u.Email})")"
                        Multiple="false"
                        OnOptionsSearch="OnOptionsSearchAsync"
                        @bind-SelectedOption="_selectedOwner" />
</div>

<div style="margin-top:1rem;">
    <button class="btn btn-primary" disabled="@(_selectedDamId == null || _selectedSireId == null)" @onclick="BreedAsync">
        Breed selected pair
    </button>
</div>

@if (_breedResult is not null)
{
    <div style="margin-top:1rem;">
        <strong>Breed result:</strong> @_breedResult
    </div>
}

@code {
    IEnumerable<HorseResult> _dams = [];
    IEnumerable<HorseResult> _sires = [];

    bool _loadingDams = true;
    bool _loadingSires = true;

    Guid? _selectedDamId;
    Guid? _selectedSireId;

    private int SelectedSireIndex { get; set; }
    private void OnSireChanged(HorseResult? horse)
        => _selectedSireId = horse?.Id;

    private int SelectedDamIndex { get; set; }
    private void OnDamChanged(HorseResult? horse)
        => _selectedDamId = horse?.Id;

    string? _breedResult;

    // Autocomplete owner selection
    private UserResult? _selectedOwner;

    protected override async Task OnInitializedAsync()
    {
        // Load dams and sires in parallel
        var damsTask = BreedingApi.GetDamsAsync();
        var siresTask = BreedingApi.GetSiresAsync();

        var damsResp = await damsTask;
        var siresResp = await siresTask;

        // Ensure deterministic sorting (case-insensitive by Name)
        _dams = (damsResp ?? [])
            .OrderBy(h => h.Name, StringComparer.OrdinalIgnoreCase)
            .ToList();

        _sires = (siresResp ?? [])
            .OrderBy(h => h.Name, StringComparer.OrdinalIgnoreCase)
            .ToList();

        _selectedDamId = _dams.First().Id;
        _selectedSireId = _sires.First().Id;

        _loadingDams = false;
        _loadingSires = false;

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnOptionsSearchAsync(OptionsSearchEventArgs<UserResult> e)
    {
        // Called by the FluentAutocomplete when the user types. Use the UserApi to search.
        var q = e.Text.Trim();

        PaginationRequest request;
        if (string.IsNullOrWhiteSpace(q))
        {
            // Load first N users when there's no search text
            request = new PaginationRequest
            {
                Page = 1,
                Size = 20,
                SortBy = "Username",
                Direction = SharedKernel.Pagination.SortDirection.Asc
            };
        }
        else
        {
            request = new PaginationRequest
            {
                Page = 1,
                Size = 20,
                SortBy = "Username",
                Direction = SharedKernel.Pagination.SortDirection.Asc,
                Filters = new Dictionary<string, Filter>
                {
                    ["Username"] = new() { Operator = FilterOperator.Contains, Value = q }
                }
            };
        }

        var resp = await UserApi.SearchAsync(request);
        e.Items = resp?.Data ?? [];
    }

    private Task BreedAsync()
    {
        var dam = _dams.FirstOrDefault(d => d.Id == _selectedDamId);
        var sire = _sires.FirstOrDefault(s => s.Id == _selectedSireId);

        if (dam is null || sire is null)
        {
            _breedResult = "Invalid selection.";
        }
        else
        {
            var ownerPart = _selectedOwner is not null ? $" (Owner: {_selectedOwner.Username})" : string.Empty;
            _breedResult = $"Planned breeding: Dam '{dam.Name}' x Sire '{sire.Name}'{ownerPart}";
        }

        return Task.CompletedTask;
    }
}
