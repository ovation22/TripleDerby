@page "/horses/{HorseId:guid}/training-history"
@rendermode InteractiveServer

@using TripleDerby.Services.Training.DTOs
@using TripleDerby.Web.ApiClients.Abstractions
@using TripleDerby.SharedKernel

@inject ITrainingsApiClient TrainingsApi
@inject IHorseApiClient HorseApi
@inject NavigationManager Navigation

<PageTitle>Training History</PageTitle>

<h1>Training History</h1>

@if (loading)
{
    <FluentProgressRing />
    <p>Loading training history...</p>
}
else if (horse == null)
{
    <FluentMessageBar Intent="@MessageIntent.Error">
        Horse not found.
    </FluentMessageBar>
}
else
{
    <h2>@horse.Name</h2>

    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10" style="margin-bottom: 20px;">
        <FluentButton Appearance="Appearance.Accent" OnClick="@(() => Navigation.NavigateTo("/horses"))">
            Back to Horses
        </FluentButton>
        <FluentButton Appearance="Appearance.Accent" OnClick="@(() => Navigation.NavigateTo($"/horses/{HorseId}/train"))">
            Train Again
        </FluentButton>
    </FluentStack>

    @if (trainingSessions == null || !trainingSessions.Any())
    {
        <FluentMessageBar Intent="@MessageIntent.Info">
            No training history available for this horse.
        </FluentMessageBar>
    }
    else
    {
        <FluentDataGrid Items="@trainingSessions.AsQueryable()"
                        TGridItem="TrainingHistoryResult"
                        GridTemplateColumns="1fr 1fr 1fr 1fr 1fr 1fr 2fr">
            <TemplateColumn Title="Date" Sortable="true">
                @context.SessionDate.ToLocalTime().ToString("MM/dd/yyyy HH:mm")
            </TemplateColumn>
            <TemplateColumn Title="Training">
                @context.TrainingName
            </TemplateColumn>
            <PropertyColumn Property="@(s => s.SpeedGain)" Title="Speed" Sortable="true" Format="F2" Align="Align.End" />
            <PropertyColumn Property="@(s => s.StaminaGain)" Title="Stamina" Sortable="true" Format="F2" Align="Align.End" />
            <PropertyColumn Property="@(s => s.AgilityGain)" Title="Agility" Sortable="true" Format="F2" Align="Align.End" />
            <PropertyColumn Property="@(s => s.DurabilityGain)" Title="Durability" Sortable="true" Format="F2" Align="Align.End" />
            <TemplateColumn Title="Happiness" Sortable="true" SortBy="@sortByHappiness" Align="Align.End">
                <div style="color: @(context.HappinessChange >= 0 ? "green" : "red")">
                    @(context.HappinessChange >= 0 ? "+" : "")@context.HappinessChange.ToString("F1")
                </div>
            </TemplateColumn>
            <TemplateColumn Title="Notes" Align="Align.Start">
                <div>
                    @if (context.OverworkOccurred)
                    {
                        <FluentBadge Appearance="Appearance.Lightweight" BackgroundColor="orange" Color="white">
                            Overworked!
                        </FluentBadge>
                    }
                </div>
            </TemplateColumn>
        </FluentDataGrid>
    }
}

@code {
    [Parameter]
    public Guid HorseId { get; set; }

    private HorseResult? horse;
    private List<TrainingHistoryResult>? trainingSessions;
    private bool loading = true;

    GridSort<TrainingHistoryResult> sortByHappiness = GridSort<TrainingHistoryResult>
        .ByDescending(s => s.HappinessChange);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;

        // Load horse details
        horse = await HorseApi.GetByIdAsync(HorseId);

        // Load training history (limit to 50 most recent)
        trainingSessions = await TrainingsApi.GetTrainingHistoryAsync(HorseId, limit: 50);

        loading = false;
        await InvokeAsync(StateHasChanged);
    }
}
