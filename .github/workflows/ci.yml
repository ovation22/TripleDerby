name: CI

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    build:
        runs-on: ubuntu-latest
        
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
            
        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '9.0.x'
                
        - name: Restore dependencies
          run: dotnet restore
            
        - name: Build
          run: dotnet build --no-restore --configuration Release
            
        - name: Run tests with coverage
          run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --logger "trx;LogFileName=test-results.trx"
            
        - name: Publish test results
          uses: EnricoMi/publish-unit-test-result-action@v2
          if: always()
          with:
            files: '**/test-results.trx'
            
        - name: Code Coverage Report
          uses: irongut/CodeCoverageSummary@v1.3.0
          with:
            filename: '**/coverage.cobertura.xml'
            badge: true
            format: markdown
            output: both
            
        - name: Add Coverage PR Comment
          uses: marocchino/sticky-pull-request-comment@v2
          if: github.event_name == 'pull_request'
          with:
            recreate: true
            path: code-coverage-results.md
            
        - name: Write to Job Summary
          run: cat code-coverage-results.md >> $GITHUB_STEP_SUMMARY